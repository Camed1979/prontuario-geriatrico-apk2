name: Build APK CORRIGIDO - Prontu√°rio Geri√°trico

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Accept Android licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
    - name: Create project directory
      run: mkdir -p apk-project
      
    - name: Initialize npm project
      run: |
        cd apk-project
        npm init -y
        
    - name: Install TypeScript FIRST
      run: |
        cd apk-project
        npm install --save-dev typescript
        
    - name: Install Capacitor dependencies
      run: |
        cd apk-project
        npm install @capacitor/core @capacitor/cli @capacitor/android
        
    - name: Create tsconfig.json
      run: |
        cd apk-project
        cat > tsconfig.json << 'EOF'
        {
          "compilerOptions": {
            "target": "es2015",
            "module": "commonjs",
            "strict": true,
            "esModuleInterop": true,
            "skipLibCheck": true,
            "forceConsistentCasingInFileNames": true
          }
        }
        EOF
        
    - name: Initialize Capacitor
      run: |
        cd apk-project
        npx cap init "Prontuario Geriatrico" "com.medico.prontuario"
        
    - name: Create web directory
      run: |
        cd apk-project
        mkdir -p www
        
    - name: Create complete medical system
      run: |
        cd apk-project
        cat > www/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Prontu√°rio Geri√°trico</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
                    min-height: 100vh; padding: 10px;
                }
                .container { 
                    background: white; border-radius: 15px; padding: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                    max-width: 800px; margin: 0 auto;
                }
                .header { 
                    text-align: center; margin-bottom: 30px; padding: 20px;
                    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                    color: white; border-radius: 12px;
                }
                .logo { font-size: 40px; margin-bottom: 10px; }
                h1 { font-size: 24px; margin-bottom: 10px; }
                .subtitle { font-size: 14px; opacity: 0.9; }
                
                .login-form { background: #f8fafc; padding: 30px; border-radius: 12px; margin: 20px 0; }
                .form-group { margin-bottom: 20px; }
                label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
                input, select, textarea { 
                    width: 100%; padding: 12px; border: 2px solid #d1d5db;
                    border-radius: 8px; font-size: 14px;
                }
                input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; }
                
                .btn { 
                    background: #1e40af; color: white; padding: 12px 20px;
                    border: none; border-radius: 8px; cursor: pointer;
                    font-size: 14px; font-weight: 600; margin: 5px;
                }
                .btn:hover { background: #1e3a8a; }
                .btn-success { background: #059669; }
                .btn-secondary { background: #6b7280; }
                .btn-sm { padding: 8px 12px; font-size: 12px; }
                
                .dashboard { display: none; }
                .dashboard.active { display: block; }
                
                .tabs { 
                    display: flex; flex-wrap: wrap; gap: 5px; margin: 20px 0;
                    border-bottom: 2px solid #e5e7eb; overflow-x: auto;
                }
                .tab { 
                    padding: 10px 15px; cursor: pointer; border-radius: 8px 8px 0 0;
                    background: #f3f4f6; color: #6b7280; font-size: 12px;
                    min-width: 80px; text-align: center;
                }
                .tab.active { background: #1e40af; color: white; }
                
                .tab-content { display: none; padding: 20px 0; }
                .tab-content.active { display: block; }
                
                .patient-list { margin: 20px 0; }
                .patient-item { 
                    background: #f8fafc; padding: 15px; margin: 10px 0;
                    border-radius: 8px; border: 1px solid #e5e7eb;
                    cursor: pointer; transition: all 0.2s;
                }
                .patient-item:hover { border-color: #3b82f6; }
                .patient-item.selected { border-color: #1e40af; background: #eff6ff; }
                
                .medical-section { 
                    background: #f9fafb; padding: 20px; margin: 15px 0;
                    border-radius: 8px; border: 1px solid #e5e7eb;
                }
                .section-title { 
                    font-size: 16px; font-weight: 700; color: #1e293b;
                    margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;
                }
                
                .scale-item { 
                    background: white; padding: 15px; margin: 10px 0;
                    border-radius: 8px; border: 1px solid #e5e7eb;
                }
                .scale-question { font-weight: 600; margin-bottom: 10px; color: #374151; }
                .scale-options { display: flex; gap: 10px; flex-wrap: wrap; }
                .scale-option { 
                    padding: 8px 12px; border: 2px solid #e5e7eb;
                    border-radius: 6px; cursor: pointer; font-size: 12px;
                }
                .scale-option.selected { border-color: #1e40af; background: #eff6ff; }
                
                .result-box { 
                    background: #f0f9ff; border: 2px solid #0ea5e9;
                    padding: 15px; border-radius: 8px; margin: 15px 0;
                    text-align: center; font-weight: 600;
                }
                .result-normal { background: #f0fdf4; border-color: #22c55e; }
                .result-warning { background: #fffbeb; border-color: #f59e0b; }
                .result-danger { background: #fef2f2; border-color: #ef4444; }
                
                .hide { display: none !important; }
                .text-center { text-align: center; }
                .p-20 { padding: 20px; }
                
                @media (max-width: 768px) {
                    .container { padding: 10px; }
                    .tabs { justify-content: flex-start; }
                    .tab { min-width: 70px; font-size: 11px; padding: 8px 10px; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <!-- LOGIN SCREEN -->
                <div id="loginScreen">
                    <div class="header">
                        <div class="logo">üìã</div>
                        <h1>Prontu√°rio Geri√°trico</h1>
                        <div class="subtitle">Sistema M√©dico Completo - 10 Se√ß√µes</div>
                    </div>
                    
                    <div class="login-form">
                        <div class="form-group">
                            <label>Email M√©dico:</label>
                            <input type="email" id="loginEmail" value="medico@geriatria.com" placeholder="Digite seu email">
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" id="loginPassword" value="123456" placeholder="Digite sua senha">
                        </div>
                        <button class="btn" style="width: 100%;" onclick="login()">
                            Entrar no Sistema
                        </button>
                    </div>
                </div>

                <!-- DASHBOARD -->
                <div id="dashboard" class="dashboard">
                    <div class="header">
                        <div class="logo">üë®‚Äç‚öïÔ∏è</div>
                        <h1>Sistema M√©dico</h1>
                        <div class="subtitle">Prontu√°rio Geri√°trico Completo</div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="showTab('patients')">Pacientes</div>
                        <div class="tab" onclick="showTab('medical')">Prontu√°rio</div>
                        <div class="tab" onclick="showTab('profile')">Perfil</div>
                    </div>
                    
                    <!-- PATIENTS TAB -->
                    <div id="patients-tab" class="tab-content active">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>Meus Pacientes</h2>
                            <button class="btn btn-success" onclick="addPatient()">+ Novo Paciente</button>
                        </div>
                        
                        <div class="patient-list" id="patientList">
                            <div class="patient-item" onclick="selectPatient(this, 'Jos√© Silva')">
                                <h3>Jos√© Silva</h3>
                                <p>Idade: 72 anos | Cidade: S√£o Paulo</p>
                                <p>Telefone: (11) 99999-1111</p>
                            </div>
                            <div class="patient-item" onclick="selectPatient(this, 'Maria Santos')">
                                <h3>Maria Santos</h3>
                                <p>Idade: 68 anos | Cidade: Rio de Janeiro</p>
                                <p>Telefone: (21) 99999-2222</p>
                            </div>
                            <div class="patient-item" onclick="selectPatient(this, 'Carlos Oliveira')">
                                <h3>Carlos Oliveira</h3>
                                <p>Idade: 75 anos | Cidade: Belo Horizonte</p>
                                <p>Telefone: (31) 99999-3333</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MEDICAL TAB -->
                    <div id="medical-tab" class="tab-content">
                        <div id="noPatientSelected" class="text-center p-20">
                            <h3>Selecione um paciente para abrir o prontu√°rio</h3>
                            <p>Clique em um paciente na lista para visualizar o prontu√°rio m√©dico</p>
                        </div>
                        
                        <div id="medicalRecord" class="hide">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 id="patientName">Prontu√°rio do Paciente</h2>
                                <div>
                                    <button class="btn btn-success btn-sm" onclick="saveRecord()">Salvar</button>
                                    <button class="btn btn-secondary btn-sm" onclick="generatePDF()">PDF</button>
                                </div>
                            </div>
                            
                            <div class="tabs">
                                <div class="tab active" onclick="showMedicalTab('dados')">Dados</div>
                                <div class="tab" onclick="showMedicalTab('historia')">Hist√≥ria</div>
                                <div class="tab" onclick="showMedicalTab('cognitivo')">Cognitivo</div>
                                <div class="tab" onclick="showMedicalTab('vacinas')">Vacinas</div>
                                <div class="tab" onclick="showMedicalTab('sarcopenia')">Sarcopenia</div>
                                <div class="tab" onclick="showMedicalTab('fragilidade')">Fragilidade</div>
                                <div class="tab" onclick="showMedicalTab('nutricao')">Nutri√ß√£o</div>
                                <div class="tab" onclick="showMedicalTab('humor')">Humor</div>
                                <div class="tab" onclick="showMedicalTab('rastreios')">Rastreios</div>
                                <div class="tab" onclick="showMedicalTab('conduta')">Conduta</div>
                            </div>
                            
                            <!-- SE√á√ÉO 1: DADOS -->
                            <div id="dados-content" class="tab-content active">
                                <div class="medical-section">
                                    <div class="section-title">1. Dados do Paciente</div>
                                    <div class="form-group">
                                        <label>Nome Completo:</label>
                                        <input type="text" id="patientFullName" placeholder="Nome completo">
                                    </div>
                                    <div class="form-group">
                                        <label>Data de Nascimento:</label>
                                        <input type="date" id="patientBirthDate">
                                    </div>
                                    <div class="form-group">
                                        <label>Sexo:</label>
                                        <select id="patientSex">
                                            <option value="">Selecione</option>
                                            <option value="M">Masculino</option>
                                            <option value="F">Feminino</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Telefone:</label>
                                        <input type="tel" id="patientPhone" placeholder="(11) 99999-9999">
                                    </div>
                                    <div class="form-group">
                                        <label>Cidade:</label>
                                        <input type="text" id="patientCity" placeholder="Cidade">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 2: HIST√ìRIA -->
                            <div id="historia-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">2. Hist√≥ria Cl√≠nica</div>
                                    <div class="form-group">
                                        <label>Queixa Principal:</label>
                                        <textarea id="chiefComplaint" rows="3" placeholder="Descreva a queixa principal"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Hist√≥ria da Doen√ßa Atual:</label>
                                        <textarea id="currentIllness" rows="4" placeholder="HDA detalhada"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Medica√ß√µes Atuais:</label>
                                        <textarea id="currentMedications" rows="3" placeholder="Liste medica√ß√µes em uso"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 3: COGNITIVO -->
                            <div id="cognitivo-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">3. Avalia√ß√£o Cognitiva</div>
                                    <div class="form-group">
                                        <label>Escolaridade (anos):</label>
                                        <input type="number" id="education" placeholder="Anos de estudo" min="0" max="25">
                                    </div>
                                    <div class="form-group">
                                        <label>MEEM (0-30):</label>
                                        <input type="number" id="meem" placeholder="Pontua√ß√£o MEEM" min="0" max="30">
                                    </div>
                                    <div class="form-group">
                                        <label>Teste do Rel√≥gio:</label>
                                        <select id="clockTest">
                                            <option value="">Selecione</option>
                                            <option value="normal">Normal</option>
                                            <option value="alterado">Alterado</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Flu√™ncia Verbal:</label>
                                        <input type="number" id="verbalFluency" placeholder="Animais em 1 minuto" min="0">
                                    </div>
                                    <div id="cognitiveResults" class="result-box hide">
                                        <div id="cognitiveResultText"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 4: VACINAS -->
                            <div id="vacinas-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">4. Vacina√ß√£o</div>
                                    <div class="form-group">
                                        <label>Influenza:</label>
                                        <select id="influenza">
                                            <option value="">Selecione</option>
                                            <option value="aplicada">Aplicada</option>
                                            <option value="nao_aplicada">N√£o Aplicada</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Pneumoc√≥cica:</label>
                                        <select id="pneumococcal">
                                            <option value="">Selecione</option>
                                            <option value="aplicada">Aplicada</option>
                                            <option value="nao_aplicada">N√£o Aplicada</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Herpes Zoster:</label>
                                        <select id="zoster">
                                            <option value="">Selecione</option>
                                            <option value="aplicada">Aplicada</option>
                                            <option value="nao_aplicada">N√£o Aplicada</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 5: SARCOPENIA -->
                            <div id="sarcopenia-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">5. Sarcopenia (SARC-F)</div>
                                    
                                    <div class="scale-item">
                                        <div class="scale-question">Carregar 5kg - Quanta dificuldade?</div>
                                        <div class="scale-options">
                                            <div class="scale-option" data-question="sarc1" data-value="0">Nenhuma = 0</div>
                                            <div class="scale-option" data-question="sarc1" data-value="1">Alguma = 1</div>
                                            <div class="scale-option" data-question="sarc1" data-value="2">Muita = 2</div>
                                        </div>
                                    </div>
                                    
                                    <div class="scale-item">
                                        <div class="scale-question">Caminhar - Quanta dificuldade?</div>
                                        <div class="scale-options">
                                            <div class="scale-option" data-question="sarc2" data-value="0">Nenhuma = 0</div>
                                            <div class="scale-option" data-question="sarc2" data-value="1">Alguma = 1</div>
                                            <div class="scale-option" data-question="sarc2" data-value="2">Muita = 2</div>
                                        </div>
                                    </div>
                                    
                                    <div class="scale-item">
                                        <div class="scale-question">Levantar da cadeira - Quanta dificuldade?</div>
                                        <div class="scale-options">
                                            <div class="scale-option" data-question="sarc3" data-value="0">Nenhuma = 0</div>
                                            <div class="scale-option" data-question="sarc3" data-value="1">Alguma = 1</div>
                                            <div class="scale-option" data-question="sarc3" data-value="2">Muita = 2</div>
                                        </div>
                                    </div>
                                    
                                    <div class="scale-item">
                                        <div class="scale-question">Subir escadas - Quanta dificuldade?</div>
                                        <div class="scale-options">
                                            <div class="scale-option" data-question="sarc4" data-value="0">Nenhuma = 0</div>
                                            <div class="scale-option" data-question="sarc4" data-value="1">Alguma = 1</div>
                                            <div class="scale-option" data-question="sarc4" data-value="2">Muita = 2</div>
                                        </div>
                                    </div>
                                    
                                    <div class="scale-item">
                                        <div class="scale-question">Quedas no √∫ltimo ano:</div>
                                        <div class="scale-options">
                                            <div class="scale-option" data-question="sarc5" data-value="0">Nenhuma = 0</div>
                                            <div class="scale-option" data-question="sarc5" data-value="1">1-3 = 1</div>
                                            <div class="scale-option" data-question="sarc5" data-value="2">4+ = 2</div>
                                        </div>
                                    </div>
                                    
                                    <div id="sarcResults" class="result-box hide">
                                        <div id="sarcResultText"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 6: FRAGILIDADE -->
                            <div id="fragilidade-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">6. Fragilidade</div>
                                    <div class="form-group">
                                        <label>Perda de peso involunt√°ria:</label>
                                        <select id="weightLoss">
                                            <option value="">Selecione</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Exaust√£o:</label>
                                        <select id="exhaustion">
                                            <option value="">Selecione</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Baixa atividade f√≠sica:</label>
                                        <select id="lowActivity">
                                            <option value="">Selecione</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Lentid√£o:</label>
                                        <select id="slowness">
                                            <option value="">Selecione</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Fraqueza:</label>
                                        <select id="weakness">
                                            <option value="">Selecione</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 7: NUTRI√á√ÉO -->
                            <div id="nutricao-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">7. Nutri√ß√£o</div>
                                    <div class="form-group">
                                        <label>Peso (kg):</label>
                                        <input type="number" id="weight" placeholder="Peso em kg" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>Altura (cm):</label>
                                        <input type="number" id="height" placeholder="Altura em cm">
                                    </div>
                                    <div class="form-group">
                                        <label>IMC:</label>
                                        <input type="number" id="bmi" placeholder="Calculado automaticamente" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>Albumina s√©rica:</label>
                                        <input type="text" id="albumin" placeholder="g/dL">
                                    </div>
                                    <div id="nutritionResults" class="result-box hide">
                                        <div id="nutritionResultText"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 8: HUMOR -->
                            <div id="humor-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">8. Humor (GDS-15)</div>
                                    <div class="form-group">
                                        <label>Pontua√ß√£o GDS-15:</label>
                                        <input type="number" id="gds15" placeholder="Pontua√ß√£o (0-15)" min="0" max="15">
                                    </div>
                                    <div id="humorResults" class="result-box hide">
                                        <div id="humorResultText"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 9: RASTREIOS -->
                            <div id="rastreios-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">9. Rastreios</div>
                                    <div class="form-group">
                                        <label>Mamografia:</label>
                                        <select id="mammography">
                                            <option value="">Selecione</option>
                                            <option value="em_dia">Em dia</option>
                                            <option value="atrasada">Atrasada</option>
                                            <option value="nao_indicada">N√£o indicada</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Colonoscopia:</label>
                                        <select id="colonoscopy">
                                            <option value="">Selecione</option>
                                            <option value="em_dia">Em dia</option>
                                            <option value="atrasada">Atrasada</option>
                                            <option value="nao_indicada">N√£o indicada</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Densitometria √≥ssea:</label>
                                        <select id="densitometry">
                                            <option value="">Selecione</option>
                                            <option value="em_dia">Em dia</option>
                                            <option value="atrasada">Atrasada</option>
                                            <option value="nao_indicada">N√£o indicada</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO 10: CONDUTA -->
                            <div id="conduta-content" class="tab-content">
                                <div class="medical-section">
                                    <div class="section-title">10. Conduta M√©dica</div>
                                    <div class="form-group">
                                        <label>Diagn√≥sticos:</label>
                                        <textarea id="diagnoses" rows="3" placeholder="Lista de diagn√≥sticos"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Prescri√ß√µes:</label>
                                        <textarea id="prescriptions" rows="4" placeholder="Medica√ß√µes prescritas"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Orienta√ß√µes:</label>
                                        <textarea id="orientations" rows="3" placeholder="Orienta√ß√µes ao paciente"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Retorno:</label>
                                        <input type="date" id="returnDate">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PROFILE TAB -->
                    <div id="profile-tab" class="tab-content">
                        <div class="medical-section">
                            <div class="section-title">Perfil do M√©dico</div>
                            <div class="text-center p-20">
                                <h3>Dr. Sistema M√©dico</h3>
                                <p>Especialista em Geriatria</p>
                                <p>CRM: 123456</p>
                                <button class="btn" onclick="logout()">Sair do Sistema</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Global variables
                let selectedPatient = null;
                let sarcFScores = { sarc1: 0, sarc2: 0, sarc3: 0, sarc4: 0, sarc5: 0 };
                
                // Login function
                function login() {
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    if (email === 'medico@geriatria.com' && password === '123456') {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('dashboard').classList.add('active');
                        alert('Login realizado com sucesso!');
                    } else {
                        alert('Email ou senha incorretos!');
                    }
                }
                
                // Logout function
                function logout() {
                    document.getElementById('loginScreen').style.display = 'block';
                    document.getElementById('dashboard').classList.remove('active');
                }
                
                // Tab navigation
                function showTab(tabName) {
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    document.getElementById(tabName + '-tab').classList.add('active');
                    event.target.classList.add('active');
                }
                
                // Medical record tabs
                function showMedicalTab(tabName) {
                    document.querySelectorAll('#medicalRecord .tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('#medicalRecord .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    document.getElementById(tabName + '-content').classList.add('active');
                    event.target.classList.add('active');
                }
                
                // Patient selection
                function selectPatient(element, patientName) {
                    document.querySelectorAll('.patient-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    element.classList.add('selected');
                    selectedPatient = patientName;
                    
                    // Show medical record
                    document.getElementById('noPatientSelected').style.display = 'none';
                    document.getElementById('medicalRecord').classList.remove('hide');
                    document.getElementById('patientName').textContent = 'Prontu√°rio: ' + patientName;
                    
                    // Fill patient data
                    document.getElementById('patientFullName').value = patientName;
                    
                    // Auto switch to medical tab
                    showTab('medical');
                }
                
                // Add patient
                function addPatient() {
                    const name = prompt('Nome do novo paciente:');
                    if (name) {
                        const patientList = document.getElementById('patientList');
                        const newPatient = document.createElement('div');
                        newPatient.className = 'patient-item';
                        newPatient.onclick = () => selectPatient(newPatient, name);
                        newPatient.innerHTML = `
                            <h3>${name}</h3>
                            <p>Idade: -- anos | Cidade: --</p>
                            <p>Telefone: --</p>
                        `;
                        patientList.appendChild(newPatient);
                        alert('Paciente adicionado com sucesso!');
                    }
                }
                
                // SARC-F scale handling
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('scale-option')) {
                        const question = e.target.getAttribute('data-question');
                        const value = parseInt(e.target.getAttribute('data-value'));
                        
                        // Remove previous selection
                        document.querySelectorAll(`[data-question="${question}"]`).forEach(option => {
                            option.classList.remove('selected');
                        });
                        
                        // Add new selection
                        e.target.classList.add('selected');
                        
                        if (question.startsWith('sarc')) {
                            sarcFScores[question] = value;
                            calculateSarcF();
                        }
                    }
                });
                
                // Calculate SARC-F
                function calculateSarcF() {
                    const total = Object.values(sarcFScores).reduce((sum, score) => sum + score, 0);
                    const resultBox = document.getElementById('sarcResults');
                    const resultText = document.getElementById('sarcResultText');
                    
                    if (total >= 0) {
                        let interpretation = '';
                        let className = 'result-normal';
                        
                        if (total >= 4) {
                            interpretation = `SARC-F: ${total}/10 - RISCO ALTO para sarcopenia`;
                            className = 'result-danger';
                        } else {
                            interpretation = `SARC-F: ${total}/10 - Risco baixo para sarcopenia`;
                            className = 'result-normal';
                        }
                        
                        resultText.textContent = interpretation;
                        resultBox.className = 'result-box ' + className;
                        resultBox.classList.remove('hide');
                    }
                }
                
                // Calculate BMI
                function calculateBMI() {
                    const weight = parseFloat(document.getElementById('weight').value);
                    const height = parseFloat(document.getElementById('height').value);
                    
                    if (weight && height) {
                        const heightInMeters = height / 100;
                        const bmi = weight / (heightInMeters * heightInMeters);
                        document.getElementById('bmi').value = bmi.toFixed(1);
                        
                        // Show nutrition results
                        const resultBox = document.getElementById('nutritionResults');
                        const resultText = document.getElementById('nutritionResultText');
                        
                        let interpretation = '';
                        let className = 'result-normal';
                        
                        if (bmi < 18.5) {
                            interpretation = `IMC: ${bmi.toFixed(1)} - Baixo peso`;
                            className = 'result-warning';
                        } else if (bmi < 25) {
                            interpretation = `IMC: ${bmi.toFixed(1)} - Peso normal`;
                            className = 'result-normal';
                        } else if (bmi < 30) {
                            interpretation = `IMC: ${bmi.toFixed(1)} - Sobrepeso`;
                            className = 'result-warning';
                        } else {
                            interpretation = `IMC: ${bmi.toFixed(1)} - Obesidade`;
                            className = 'result-danger';
                        }
                        
                        resultText.textContent = interpretation;
                        resultBox.className = 'result-box ' + className;
                        resultBox.classList.remove('hide');
                    }
                }
                
                // Event listeners
                document.getElementById('weight').addEventListener('input', calculateBMI);
                document.getElementById('height').addEventListener('input', calculateBMI);
                
                // MEEM evaluation
                document.getElementById('meem').addEventListener('input', function() {
                    const meem = parseInt(this.value);
                    const education = parseInt(document.getElementById('education').value) || 0;
                    
                    if (meem >= 0 && meem <= 30) {
                        let cutoff = 24; // Default cutoff
                        
                        if (education <= 4) cutoff = 17;
                        else if (education <= 8) cutoff = 22;
                        else if (education <= 11) cutoff = 24;
                        else cutoff = 26;
                        
                        const resultBox = document.getElementById('cognitiveResults');
                        const resultText = document.getElementById('cognitiveResultText');
                        
                        let interpretation = '';
                        let className = 'result-normal';
                        
                        if (meem < cutoff) {
                            interpretation = `MEEM: ${meem}/30 - Sugestivo de d√©ficit cognitivo (cutoff: ${cutoff})`;
                            className = 'result-danger';
                        } else {
                            interpretation = `MEEM: ${meem}/30 - Normal para escolaridade (cutoff: ${cutoff})`;
                            className = 'result-normal';
                        }
                        
                        resultText.textContent = interpretation;
                        resultBox.className = 'result-box ' + className;
                        resultBox.classList.remove('hide');
                    }
                });
                
                // GDS-15 evaluation
                document.getElementById('gds15').addEventListener('input', function() {
                    const gds = parseInt(this.value);
                    
                    if (gds >= 0 && gds <= 15) {
                        const resultBox = document.getElementById('humorResults');
                        const resultText = document.getElementById('humorResultText');
                        
                        let interpretation = '';
                        let className = 'result-normal';
                        
                        if (gds >= 6) {
                            interpretation = `GDS-15: ${gds}/15 - Sugestivo de depress√£o`;
                            className = 'result-danger';
                        } else {
                            interpretation = `GDS-15: ${gds}/15 - Normal`;
                            className = 'result-normal';
                        }
                        
                        resultText.textContent = interpretation;
                        resultBox.className = 'result-box ' + className;
                        resultBox.classList.remove('hide');
                    }
                });
                
                // Save record
                function saveRecord() {
                    if (!selectedPatient) {
                        alert('Selecione um paciente primeiro!');
                        return;
                    }
                    
                    alert('Prontu√°rio salvo com sucesso para ' + selectedPatient);
                }
                
                // Generate PDF
                function generatePDF() {
                    if (!selectedPatient) {
                        alert('Selecione um paciente primeiro!');
                        return;
                    }
                    
                    alert('PDF gerado com sucesso para ' + selectedPatient);
                }
            </script>
        </body>
        </html>
        EOF
        
    - name: Add Android platform
      run: |
        cd apk-project
        npx cap add android
        
    - name: Sync project
      run: |
        cd apk-project
        npx cap sync
        
    - name: Configure Gradle
      run: |
        cd apk-project/android
        echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
        echo "org.gradle.daemon=false" >> gradle.properties
        
    - name: Build APK with detailed logging
      run: |
        cd apk-project/android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --stacktrace --info
        
    - name: Verify APK creation
      run: |
        echo "Verificando arquivos gerados..."
        find apk-project/android/app/build/outputs -name "*.apk" -type f
        ls -la apk-project/android/app/build/outputs/apk/debug/
        
    - name: Create final APK directory
      run: |
        mkdir -p apk-output
        BUILD_DATE=$(date +%Y%m%d_%H%M)
        APK_NAME="ProntuarioGeriatrico_${BUILD_DATE}.apk"
        
        # Copy APK
        cp apk-project/android/app/build/outputs/apk/debug/app-debug.apk "apk-output/${APK_NAME}"
        
        # Create info file
        cat > apk-output/INSTALL_INFO.txt << EOF
        ====================================
        PRONTU√ÅRIO GERI√ÅTRICO - APK PRONTO
        ====================================
        
        üì± Arquivo: ${APK_NAME}
        üïê Gerado em: ${BUILD_DATE}
        
        üîë LOGIN:
        Email: medico@geriatria.com
        Senha: 123456
        
        ‚úÖ FUNCIONALIDADES:
        ‚Ä¢ 10 se√ß√µes m√©dicas completas
        ‚Ä¢ Escalas geri√°tricas (SARC-F, MEEM, GDS-15)
        ‚Ä¢ C√°lculos autom√°ticos (IMC, interpreta√ß√µes)
        ‚Ä¢ Gest√£o de pacientes
        ‚Ä¢ Sistema de prescri√ß√µes
        ‚Ä¢ Interface otimizada para tablets
        
        üì≤ INSTALA√á√ÉO:
        1. Baixe o APK do GitHub Actions
        2. Habilite "Fontes desconhecidas" no Android
        3. Instale o arquivo APK
        4. Fa√ßa login com as credenciais acima
        
        üéØ COMPATIBILIDADE:
        ‚Ä¢ Android 7.0+ (API 24)
        ‚Ä¢ Tablets e smartphones
        ‚Ä¢ Interface responsiva
        
        ====================================
        EOF
        
        echo "‚úÖ APK criado com sucesso: ${APK_NAME}"
        ls -la apk-output/
        
    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Prontuario-Geriatrico-APK-Final
        path: apk-output/
        retention-days: 30
        if-no-files-found: error
        
    - name: Validate artifact upload
      run: |
        echo "Validando arquivos para upload..."
        ls -la apk-output/
        echo "Contagem de arquivos:"
        find apk-output/ -type f | wc -l
        echo "Tamanho total:"
        du -sh apk-output/
